
@{
    ViewBag.Title = "Build Menu";
    ViewBag.PageDesc = "Create your menu by adding sections and products under. You can use the pen icon to rename the sections and products.";
}

<h2>All</h2>

<hr />

<div class="row">
    <div class="col-md-6">
        <div class="main-card mb-3 card">
            <div class="card-body">
                <div id="no-content"></div>
                <div class="list-container">
                    <div class="list" data-count="0">
                        <div class="item disabled">
                            <button class="btn btn-outline-success btn-sm pull-right" id="add-section">New Section <em class="fa fa-plus"></em></button>
                            <button class="btn btn-success btn-sm">Save Menu <em class="fa fa-check"></em></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="main-card mb-3 card">
            <div class="card-body bg-danger">
                <div class="trash-container">
                    <div class="trash-list" data-count="0">
                        <div class="trash-item text-white text-center">
                            Just drop the sections you want to delete to here!
                            <br />
                            <br />
                        </div>
                        <div class="trash-item disabled">
                            <button class="btn btn-danger btn-block pull-right" id="clear-trash">Clear Trash <em class="fa fa-recycle"></em></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
@section modals{
    <div id="modal-container"></div>
}

@section scripts{
    <script src="~/Content/src/assets/scripts/jquery-3.5.1.min.js"></script>
    <script src="~/Content/src/assets/scripts/html5sortable.js"></script>
    <script>
        var restData = "";
        var $nocontent = `
                    <div class="row" style="color:#EAEAEA; margin:50px">
                        <div class="col-md-12 text-center">
                            <em class="fa fa-leaf fa-6x"></em>
                        </div>
                        <br />
                        <div class="col-md-12 text-center">
                            <h4>There is no sections here.</h4>
                        </div>
                        <div class="col-md-12 text-center">
                            <p>
                                Please start by adding sections from the button below.
                            </p>
                        </div>
                    </div>
        `;

        var generateSection = function (sectionName, sectionNo) {
            var $sectionTemp = $(`
                            <div class="item">
                                <div class="section-header-bottomline h4" data-toggle="collapse" href="#section`+ sectionNo +`" aria-expanded="false">
                                    <em class="pe-7s-pen text-sm-left edit-section"></em>
                                    <label class="section-name">`+ sectionName +`</label>
                                    <em class="pe-7s-angle-right pull-right section-icon"></em>
                                </div>
                                <div class="sublist collapse" id="section`+ sectionNo +`" data-count="0">
                                    <div class="subitem disabled">
                                        <button class="btn btn-outline-success btn-sm pull-right btn-newitem">New Item <em class="fa fa-plus"></em></button>
                                    </div>
                                </div>
                            </div>`);
    

            $sectionTemp.find(".sublist").append($brNonItem);
            $sectionTemp.append($brNonItem);

            return $sectionTemp;
        };

        var generateItem = function (sectionNo, itemNo) {
            var stamp = `section` + sectionNo + `item` + itemNo;
            $itemTemp = $(`
                        <div class="subitem `+ stamp + `">
                            <h5 class="list-group-item-heading">
                                <em class="pe-7s-trash pull-right remove-item text-danger fa-fw `+ stamp + `"data-toggle="modal" data-target="#alert`+ stamp + `"></em>
                                <label class="list-itemname">New Product</label>
                                <em class="pe-7s-edit pull-right fa-fw `+ stamp + `" style="color:#FF5733;" data-toggle="modal" data-target="#`+ stamp + `"></em>
                            </h5>
                        </div>
                        `);
            return $itemTemp;
        };

        var $brNonItem = "<br class='disabled' />";

        var bind = function () {
            if (restData == "")
                toggleNoContent();
            bindItems();
            $("#add-section").off("click").on("click", addSection);
            $("#clear-trash").off("click").on("click", function () {
                $(".trash-list").find(".item").remove();
            });
        };

        var bindItems = function () {
            $(".section-header-bottomline").off("click.toggleChevron").on("click.toggleChevron", function () {
                $(this).find("em.section-icon").toggleClass("pe-7s-angle-right").toggleClass("pe-7s-angle-down");
            });

            $(".edit-section").off("click.editsection").on("click.editsection", function () {
                event.stopPropagation();
                $(this).toggleClass("text-appcolor");
                var editableState = $(this).next().attr("contenteditable");
                if (editableState == "true")
                    $(this).next().attr("contenteditable", false);
                else
                    $(this).next().attr("contenteditable", true);

                $(this).next().focus();
            });

            $("label.section-name").off('keypress.editsection').on('keypress.editsection', function (e) {
                if (e.which == 13) {
                    $(this).prev().click();
                }
            });

            $("label.item-name").off('keypress.editsection').on('keypress.editsection', function (e) {
                if (e.which == 13) {
                    $(this).prev().click();
                }
            });

            $(".btn-save-product").off("click.saveproduct").on("click.saveproduct", saveProduct);
            $(".btn-remove-product").off("click.deleteproduct").on("click.deleteproduct", deleteProduct);
            $("input[type=file]").off("change").on("change", uploadFile);

            sortable('.list', {
                items: ':not(.disabled)',
                forcePlaceholderSize: true,
                placeholderClass: 'ph-class',
                acceptFrom: '.list, .trash-list',
            });
            sortable('.sublist', {
                items: ':not(.disabled)',
                forcePlaceholderSize: true,
                placeholderClass: 'ph-sub-class',
                //acceptFrom: '.trash-sublist'
            });

            sortable('.trash-list', {
                items: ':not(.disabled)',
                forcePlaceholderSize: true,
                placeholderClass: 'ph-class',
                acceptFrom: '.list'
            });
        };

        var addSection = function () {
            var sectionCount = $(".list").attr("data-count");
            var $newSection = generateSection("New Section", sectionCount);
            $newSection.insertBefore($(this).parent());
            $newSection.find(".btn-newitem").off("click.newitem").on("click.newitem", addItem).click();
            sectionCount++;
            $(".list").attr("data-count", sectionCount);
            //toggleNoContent();
            $("#no-content").html("");
            bindItems();
        };

        var toggleNoContent = function () {
            var $noContentContainer = $("#no-content");
            if ($noContentContainer.html() == "") {
                $noContentContainer.append($nocontent);
            } else {
                $noContentContainer.html("");
            }
        };

        var addItem = function () {
            var sectionNo = $(this).parent().parent().prev().attr("href").split("#section")[1];
            var itemNo = $(this).parent().parent().attr("data-count");
            var $newItem = generateItem(sectionNo, itemNo);
            $newItem.insertBefore($(this).parent());

            var $newModal = generateModal(sectionNo, itemNo);
            $("#modal-container").append($newModal);

            itemNo++;
            $(this).parent().parent().attr("data-count", itemNo);

            bindItems();
        };

        var saveProduct = function () {
            var itemName = $(this).parent().parent().find("label.item-name").text();
            var stamp = $(this).attr("data-stamp");
            //var sectionNo = stamp.split("section")[1].split("item")[0];
            //var itemNo = stamp.split("item")[1];
            $("em." + stamp).prev().text(itemName);
            $(this).prev().click();
        };

        var deleteProduct = function () {
            var stamp = $(this).attr("data-stamp").split("alert")[1];
            $("div." + stamp).remove();
            bindItems();
            $(this).prev().click();
        };

        var generateModal = function (sectionNo, itemNo) {
            var stamp = `section` + sectionNo + `item` + itemNo;
            var $modalTemp = `        
                            <div class="modal fade `+ stamp + `" id="`+ stamp + `" tabindex="-1" role="dialog" aria-labelledby="` + stamp + `" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <div class="h5 modal-title">
                                                <em class="pe-7s-pen text-sm-left edit-section"></em>
                                                <label class="item-name">New Product</label>
                                            </div>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="input-group">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text">Price</span>
                                                    </div>
                                                    <input placeholder="25₺..." type="text" class="form-control">
                                                </div>
                                            </div>
                                            <br  />
                                            <br  />
                                            <br  />
                                            <div class="col-md-12">
                                                <div class="input-group">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text">Description</span>
                                                    </div>
                                                    <textarea class="form-control" placeholder="description..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <br />
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="input-group">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text" id="inputGroupFileAddon01">Product Image</span>
                                                    </div>
                                                    <div class="custom-file">
                                                        <form id="form`+ stamp + `" method="post" enctype="multipart/form-data">
                                                            <input type="file" class="custom-file-input" id="inputGroupFile01"
                                                                   aria-describedby="inputGroupFileAddon01">
                                                            <label class="custom-file-label" for="inputGroupFile01">Choose file</label>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                            <button type="button" class="btn btn-primary btn-save-product" data-stamp="`+ stamp +`">Save changes</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal fade `+ stamp + `" id="alert`+ stamp + `" tabindex="-1" role="dialog" aria-labelledby="alert` + stamp + `" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <div class="h5 modal-title">
                                                <label class="item-name">Warning!</label>
                                            </div>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            You are about the delete this item. Are you sure?
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                            <button type="button" class="btn btn-primary btn-remove-product" data-stamp="alert`+ stamp +`">Delete Item</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            `;

            return $modalTemp;
        };

        var uploadFile = function () {
            var fileName = $(this).val().split("\\");
            fileName = fileName[fileName.length - 1];
            $(this).next().text(fileName);

            var file = $(this)[0].files[0];
            var fileData = new FormData();
            fileData.append(file.name, file);
            toggleLoading();

            $.ajax({  
                url: '/Home/UploadFile',  
                type: "POST",  
                contentType: false, // Not to set any content header  
                processData: false, // Not to process data  
                data: fileData,  
                success: function (result) {
                    toggleLoading();
                    console.log(result);
                },  
                error: function (err) {
                    toggleLoading();
                    console.log(err);
                }  
            });  

            console.log(file);
        };

        var toggleLoading = function (stamp) {
            $loadingWrapper = $("form#form" + stamp).parent().prev().find("span");
            if ($loadingWrapper.text() == "Product Image") {
                $loadingWrapper.text() = "";
                $loadingWrapper.append("<em class='fa fa-spinner fa-spin' />");
            } else {
                $loadingWrapper.html("Product Image");
            }
        };

        bind();
    </script>
}

@section styles{
    <style>
        em:hover{
            cursor:pointer;
        }

        label.section-name{
            width:80%
        }
        .section-icon {
            color: #FF5733;
            font-size: 40px;
            /*margin-top: 10px;*/
            /*margin-right: 5px;*/

        }

        .ph-sub-class {
            background-color: #EAEAEA;
            margin: 20px;
        }

        .ph-class {
            background-color: #EAEAEA;
            /*margin: 20px;*/
        }

        .section-header-bottomline {
            line-height: 40px;
            border-bottom-width:1.5px
        }

        .item {
            /*background-color: white!important;*/
        }

        .trash-list > .item{
            color:white!important;
        }

        .sublist {
            /*margin-left: 20px;*/
        }

        .subitem {
            /*font-size: 11px;*/
            margin: 20px;
            /*border-bottom-style:solid;
            border-bottom-width:1px;
            border-bottom-color:#EAEAEA;*/
        }
    </style>
}